#RetroDevStudio.MetaData.BASIC:7169,BASIC V7.0,uppercase,10,10

# SOME COMMON CODE TO REDUCE SIZE OF BINARY

# DEC("9B")=155
100 M=155
120 K=PEEK(981)

#  BANK
130 B=PEEK(996)

#  START ADDRESS
132 A=PEEK(997)
134 A=PEEK(998)*256+A

140 GOTO 2010

# END 
200 BANK K
210 END



########################################
# SOURCE: GBPACK-MC.BAS                #
# THIS PROGRAM READS UNCOMPRESSED      #
# PRINTFOX GB DATA AND COMPRESSES IT   #
#                                      #
# SOURCE FILE FOR MC128 MICROCOMPILER  #
#                                      #
# WRITTEN 2024 BY GOODWELL             #
#              FROM THE 8-BIT THEORY   #
########################################

# A=SOURCE ADDR
# B=SOURCE BANK
# C=DEST ADDR
# D=DEST BANK

# K=ORIGINAL BANK NUMBER
# M=MAGIC BYTE
# I=INPUT OFFSET
# O=OUTPUT OFFSET
# R=REPEATS
# L=REPEATS LOW-BYTE
# H=REPEATS HIGH-BYTE
# N=NEXT VALUE
# V=VALUE
# Y=LOOP VARIABLE

# SOURCE BANK: 996
# SOURCE START ADDRESS (COMP GB):997/998

# DEST BANK: 999
# DEST START ADDRESS (UNCOMP GB):1000/1001

# END ADDRESS OF PACKED FILE: 1002/1003


# UNCOMP.GB SOURCE
#  BANK
#2000 B=PEEK(996)

#  START ADDRESS
#2020 A=PEEK(997)
#2030 A=PEEK(998)*256+A




# COMP.GB DESTINATION
#   BANK
2010 D=PEEK(999)

#   ADDRESS
2050 C=PEEK(1000)
2060 C=PEEK(1001)*256+C

2080 O=1
2090 I=0
2100 R=1

# WRITE HEADER-BYTE "B"
2110 BANK D:POKE C,66


2130 BANK B
2140 V=PEEK(A+I)

2150  BANK B
2160  I=I+1
2170  N=PEEK(A+I)

2180  IF N<>V THEN GOTO 2290

2190  R=R+1

2200  V=N

2210 IF I>8193 THEN GOTO 2230

2220 GOTO 2150

# POKE END-ADDRESS OF PACKED FILE TO MEMORY (EXCLUDING)
2230 R=C+O
2235 H=R/256
2260 L=H*256:L=R-L

2270 POKE 1002,L:POKE 1003,H

2280 GOTO 200


# VALUE IS DIFFERENT TO PREVIOUS, TIME TO WRITE DATA
2290 BANK D

2295 IF V=M THEN GOTO 2340
2300 IF R>4 THEN GOTO 2340
#2310 IF R>1 THEN GOTO 2500

# WRITE PLAIN VALUE
2320 FOR Y=1 TO R:POKE C+O,V:O=O+1:NEXT
#2320 POKE C+O,V:O=O+1
2325 R=1
2330 GOTO 2200


# WRITE PACKED VALUE
2340 POKE C+O,M:O=O+1

2360 H=R/256
2370 L=H*256:L=R-L

# REPEATS LOW-BYTE
2380 POKE C+O,L:O=O+1

# REPEATS HIGH-BYTE
2390 POKE C+O,H:O=O+1

2400 POKE C+O,V:O=O+1
2410 R=1

2420 GOTO 2200




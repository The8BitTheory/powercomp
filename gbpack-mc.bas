#RetroDevStudio.MetaData.BASIC:7169,BASIC V7.0,uppercase,10,10
########################################
# THIS PROGRAM READS A COMPRESSED      #
# PRINTFOX GB FILE AND UNCOMPRESSES IT #
#                                      #
# SOURCE FILE FOR MC128 MICROCOMPILER  #
#                                      #
# WRITTEN 2024 BY GOODWELL             #
#              FROM THE 8-BIT THEORY   #
########################################

# A=SOURCE ADDR
# B=SOURCE BANK
# C=DEST ADDR
# D=DEST BANK

# K=ORIGINAL BANK NUMBER
# M=MAGIC BYTE
# I=INPUT OFFSET
# O=OUTPUT OFFSET
# R=REPEATS
# N=NEXT VALUE
# V=VALUE
# Y=LOOP VARIABLE

# SOURCE BANK: 996
# SOURCE START ADDRESS (COMP GB):997/998

# DEST BANK: 999
# DEST START ADDRESS (UNCOMP GB):1000/1001

60 K=PEEK(981)

# UNCOMP.GB SOURCE
#  BANK
70 B=PEEK(996)

#  START ADDRESS
80 A=PEEK(997)
90 A=PEEK(998)*256+A

# COMP.GB DESTINATION
#   BANK
150 D=PEEK(999)

#   ADDRESS
160 C=PEEK(1000)
170 C=PEEK(1001)*256+C



# DEC("9B")=155
210 M=155

230 O=0
235 R=1

240 A=A+1

244 BANK B
245 V=PEEK(A+I)

260  BANK B
265  I=I+1
270  N=PEEK(A+I)

280  IF N<>V THEN GOTO 320

282  R=R+1
284  V=N

300 IF I>31999 THEN GOTO 314

304 GOTO 260

314 BANK K

316 END


# WRITE PLAIN VALUE
320 BANK D
321 IF R>1 THEN GOTO 330
322 POKE C+O,V
324 O=O+1

328 GOTO 284


# WRITE PACKED VALUE
330 POKE C+O,M:O=O+1
334 POKE C+O,R:O=O+2:REM THIS NEEDS TO BE LOW-BYTE/HIGH-BYTE
336 POKE C+O,V
337 R=1
338 GOTO 284


